<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        body {
            margin: 10px;
        }

        /* Loader CSS */
        #loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
            display: none;
            /* Initially hidden */
            position: absolute;
            top: 45%;
            left: 45%;
            transform: translate(-50%, -50%);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #responseContainer {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
        }

        .code-block {
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <input type="text" id="prompt" placeholder="enter the prompt here">
    <button onclick="getResponse()">submit</button>
    <div id="loader"></div>
    <div id="responseContainer"></div>

    <script>
        const api = "http://localhost:11434/api/generate";
        const promptValue = document.getElementById("prompt");
        const responseContainer = document.getElementById("responseContainer");

        const showPrompt = () => {
            console.log(promptValue.value);
        }

        const getResponse = async () => {
            showPrompt();
            const loader = document.getElementById("loader");

            loader.style.display = "block";

            try {
                const res = await fetch(api, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "llama3",
                        "prompt": promptValue.value
                    })
                });

                console.log(res); 

                const text = await res.text(); 
                console.log(text); 

                const jsonStrings = text.split(/(?<=})\s*(?={)/);

                responseContainer.innerHTML = "";

                let concatenatedResponse = "";
                const responses = jsonStrings.map(jsonStr => JSON.parse(jsonStr));
                responses.forEach(data => {
                    console.log(data); 
                    console.log(data.response);
                    concatenatedResponse += data.response;
                });

                const escapeHtml = (text) => {
                    return text
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;");
                };

                const formatResponse = (response) => {
                    response = response.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
                    response = response.replace(/```([\s\S]*?)```/g, (match, p1) => {
                        return `<pre class="code-block">${escapeHtml(p1)}</pre>`;
                    });
                    return response;
                };

                responseContainer.innerHTML = formatResponse(concatenatedResponse);

            } catch (error) {
                console.log(error);
            } finally {
                loader.style.display = "none";
            }
        }
    </script>
</body>

</html>